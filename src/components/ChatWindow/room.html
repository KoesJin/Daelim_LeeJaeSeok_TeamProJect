<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅방</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h1>채팅방</h1>
<div>
    <input type="text" id="senderId" placeholder="보낸 사람 ID">
    <input type="text" id="message" placeholder="메시지">
    <button id="sendButton">보내기</button>
</div>
<div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll;">
    <!-- 메시지 표시 영역 -->
</div>

<script>
    const chatRoomId = localStorage.getItem("chatRoomId"); // 로컬 스토리지에서 chatRoomId 가져오기
    const senderIdInput = document.getElementById("senderId");
    const messageInput = document.getElementById("message");
    const sendButton = document.getElementById("sendButton");
    const messagesDiv = document.getElementById("messages");

    let currentPage = 0; // 현재 페이지
    const size = 30;     // 페이지당 불러올 채팅 수
    let isFetching = false; // 중복 요청 방지용 플래그

    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe(`/topic/${chatRoomId}`, function (message) {
            const chatMessage = JSON.parse(message.body);
            displayMessage(chatMessage); // 새로운 메시지를 화면에 추가
        });
    });

    window.onload = function () {
        if (chatRoomId) {
            fetchChatMessages(); // 초기 채팅 메시지 불러오기
        }
    };

    sendButton.addEventListener("click", function () {
        const messageContent = messageInput.value;
        const senderId = senderIdInput.value;

        if (messageContent && senderId && chatRoomId) { // chatRoomId도 확인
            const chatMessage = {
                senderId: senderId,
                message: messageContent,
                chatRoomId: chatRoomId // chatRoomId를 메시지에 추가
            };
            stompClient.send(`/app/chat/send`, {}, JSON.stringify(chatMessage));
            messageInput.value = ''; // 메시지 전송 후 입력 필드 초기화
        } else {
            alert("모든 필드를 입력해 주세요!"); // 모든 필드 입력 체크
        }
    });

    function formatSendTime(sendTime) {
        const now = new Date(); // 현재 시간
        const sendDate = new Date(sendTime); // 메시지 보낸 시간

        // sendTime이 Invalid Date인지 확인
        if (isNaN(sendDate.getTime())) {
            return "시간 정보가 없습니다."; // 오류 메시지
        }

        const isSameYear = now.getFullYear() === sendDate.getFullYear(); // 같은 해인지 확인
        const isSameDay = now.toDateString() === sendDate.toDateString(); // 같은 날짜인지 확인

        if (isSameDay) {
            // 오늘이면 "HH:mm"
            return sendDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
        } else if (isSameYear) {
            // 올해이지만 오늘은 아닌 경우 "MM.dd HH:mm"
            return sendDate.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' }) + ' ' +
                sendDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
        } else {
            // 다른 해일 경우 "YY.MM.dd HH:mm"
            return sendDate.toLocaleDateString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit' }) + ' ' +
                sendDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
    }

    function fetchChatMessages() {
        if (isFetching) return; // 중복 요청 방지
        isFetching = true;

        const requestParams = new URLSearchParams({
            page: currentPage,
            size: size
        });

        fetch(`/chat/${chatRoomId}?${requestParams.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.content.length > 0) {
                    // 데이터를 가장 위에 추가
                    data.content.forEach(chat => {
                        prependMessage(chat); // 메시지를 표시
                    });
                    currentPage++; // 페이지 증가
                    scrollToBottom(); // 맨 아래로 스크롤
                } else {
                    alert("더 이상 메시지가 없습니다."); // 더 이상 메시지가 없을 때
                }
                isFetching = false;
            })
            .catch(error => {
                console.error('Error fetching chat history:', error);
                isFetching = false;
            });
    }

    function displayMessage(message) {
        const messageElement = document.createElement("div");

        // 시간 포맷팅 (보낸 시간을 처리)
        const formattedTime = formatSendTime(message.sendTime);

        // 메시지 출력 (포맷된 시간을 사용)
        messageElement.textContent = `${message.userRealName}: ${message.message} (보낸 시간: ${formattedTime})`;

        messagesDiv.append(messageElement); // 아래에 추가
        scrollToBottom();
    }

    function prependMessage(message) {
        const messageElement = document.createElement("div");

        // 시간 포맷팅 (보낸 시간을 처리)
        const formattedTime = formatSendTime(message.sendTime);

        // 메시지 출력 (포맷된 시간을 사용)
        messageElement.textContent = `${message.userRealName}: ${message.message} (보낸 시간: ${formattedTime})`;

        messagesDiv.prepend(messageElement); // 위에 추가
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // 스크롤을 가장 아래로 이동
    }

</script>
</body>
</html>
